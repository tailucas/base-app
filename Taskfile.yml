# https://taskfile.dev

version: '3'

vars:
  USER_ID: 999
  GROUP_ID: 999

tasks:
  default:
    cmds:
      - task: build
  datadir:
    desc: Create system user and associate with docker group.
    cmds:
      - mkdir -p ./data/
      - sudo chown {{.USER_ID}}:{{.GROUP_ID}} ./data/
      - sudo chmod 755 ./data/
      - sudo chmod g+rws ./data/
      - sudo rm -f ./data/app-std* ./data/cron-std* ./data/supervisor.sock
    generates:
      - ./data/
  java:
    desc: Build Java artifacts in preparation for container build.
    preconditions:
      - java -version
      - javac -version
      - mvn -v
    cmds:
      - mvn package
      - mvn dependency:tree
    generates:
      - target/app-0.1.0-jar-with-dependencies.jar
  python:
    desc: Create and initialize Python virtual environment.
    preconditions:
      - uv -V
    cmds:
      - uv python install
      - uv sync
    generates:
      - .venv
  configure:
    desc: Create runtime configuration.
    deps: [build]
    preconditions:
      - docker -v
      - docker compose version
    cmds:
      - rm -f .env
      - cp base.env .env
      - echo "" >> .env
      - docker compose run --remove-orphans app /opt/app/dot_env_setup.sh >> .env
      - test $(wc -l < .env) -ge 2
    generates:
      - .env
  push:
    deps: [build]
    desc: Push built image to Docker Hub
    preconditions:
      - docker compose images
    cmds:
      - docker compose push
  build:
    desc: Clean up volume directory and build container image.
    preconditions:
      - docker -v
    cmds:
      - docker compose --env-file base.env build --progress plain
  run:
    deps: [datadir, build, configure]
    desc: Run docker container
    preconditions:
      - docker -v
      - test -f docker-compose.yml
      - docker ps | grep 1password
      - test -d ./data/
    cmds:
      - docker compose up --remove-orphans
  rund:
    deps: [datadir, build, configure]
    desc: Run docker container and detach
    preconditions:
      - docker -v
      - test -f docker-compose.yml
      - docker ps | grep 1password
      - test -d ./data/
    cmds:
      - docker compose up -d --remove-orphans
